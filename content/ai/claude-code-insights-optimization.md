---
title: "Claude Code /insights로 사용 패턴 분석하고 12개 개선안 전부 반영하기"
weight: 1
description: "/insights 리포트가 알려준 문제 패턴을 CLAUDE.md, 커스텀 스킬, 훅, 헤드리스 스크립트로 해결한 과정"
tags: ["AI", "Claude Code", "insights", "CLAUDE.md", "Skills", "Hooks", "DevOps"]
keywords: ["Claude Code insights", "CLAUDE.md 최적화", "Claude Code 커스텀 스킬", "Claude Code 훅", "AI 에이전트 개선"]
---

도구의 효율은 도구 자체보다 사용 방법에 달려 있다. Claude Code를 5주간 6,000개 세션에서 사용하면서, 도구 자체는 강력했지만 반복되는 마찰이 있었다. 서버 재시작이 매번 꼬이고, 분석 결과에 사실 오류가 섞이고, SSO 토큰이 핵심 순간에 만료되었다.

문제는 도구가 아니라 사용 방법이었다. Claude Code의 `/insights` 명령어로 사용 패턴을 분석한 결과, 어디서 시간을 낭비하고 있는지 명확하게 드러났다. 리포트가 제안한 12개 개선안을 CLAUDE.md, 커스텀 스킬, 훅, 헤드리스 스크립트에 전부 반영한 과정을 공유한다.

---

## /insights가 뭔가

Claude Code의 `/insights`는 사용 패턴을 분석해서 개인화된 리포트를 생성하는 기능이다. 로컬에 저장된 세션 데이터를 기반으로 다음을 보여준다:

- **작업 영역**: 어떤 작업에 얼마나 시간을 쓰는지
- **사용 패턴**: 도구 사용 빈도, 마찰 유형, 달성도
- **문제 발생 지점**: 반복되는 실패 패턴
- **추천 기능**: CLAUDE.md 추가 제안, 커스텀 스킬, 훅, 헤드리스 모드
- **새로운 활용법**: 프롬프트 패턴 개선
- **미래 전망**: 자동화 확장 방향

HTML 파일로 생성되며, 차트와 수치로 시각화된다.

---

## 리포트가 보여준 것

5,939개 세션, 74,588개 메시지, 3,688개 커밋의 데이터를 분석한 결과다.

### 주요 작업 분포

| 작업 | 세션 수 | 비고 |
|------|---------|------|
| 서버 관리/재시작 | ~176 | 가장 빈번, 부분 달성 반복 |
| 콘텐츠 작성/수정 | ~160 | Slack, Jira 게시물 |
| 프론트엔드 개발 | ~100 | CSS 14K, HTML 8K 상호작용 |
| Datadog 비용 조사 | ~96 | MCP 17K+ 호출 |
| Jira/AWS 비용 관리 | ~39 | SSO 만료로 중단 빈발 |

### 가장 많이 쓴 도구

| 도구 | 호출 수 |
|------|---------|
| Bash | 110,329 |
| Edit | 30,815 |
| Read | 30,715 |
| Datadog 로그 | 9,886 |
| Playwright 스크린샷 | 6,590 |

### 핵심 마찰 패턴

리포트가 짚어준 세 가지 반복 문제:

**1. 서버 재시작의 반복 실패 (176건)**

가장 빈번한 작업인 서버 재시작이 매번 부분 달성으로 끝났다. 복수 인스턴스가 남아있거나, 자동 재시작이 동작하거나, 포트 충돌이 발생했다. 재시작 절차가 Claude에게 명확히 정의되어 있지 않았기 때문이다.

**2. 분석 결과의 사실 오류 (208건)**

Datadog 비용 조사에서 Claude가 요일을 틀리거나, 근거 없이 필터가 자동 활성화되었다고 가정하거나, 추측을 확정처럼 서술했다. Slack/Jira에 게시하기 전에 매번 수동으로 팩트체크해야 했다.

**3. SSO 토큰 만료 (7건, 영향도 높음)**

AWS 비용 분석 중간에 토큰이 만료되면 워크플로우가 통째로 중단되었다. 빈도는 적지만, 발생 시 복잡한 멀티스텝 작업의 컨텍스트를 잃어버리는 문제가 있었다.

---

## 12개 개선안 분류

/insights 리포트의 추천 기능, 새로운 활용법, 미래 전망 섹션에서 도출한 12개 개선안을 세 카테고리로 분류했다.

### A. CLAUDE.md 추가 (3개) - 지시사항 강화

| # | 개선안 | 해결하는 문제 |
|---|--------|--------------|
| 1 | 서버 관리 규칙 (5단계 표준 절차) | 재시작 176건 부분 달성 |
| 2 | 분석/작성 기준 (유보적 표현, 날짜 검증) | 사실 오류 208건 |
| 3 | SSO 사전 인증 점검 | 토큰 만료 중단 |

### B. 기능 구현 (3개) - 스킬, 훅, 스크립트

| # | 개선안 | 형태 |
|---|--------|------|
| 4 | /restart 커스텀 스킬 | `.claude/skills/restart/SKILL.md` |
| 5 | PostToolUse 훅 (Prettier, ruff) | `.claude/settings.json` |
| 6 | 헤드리스 모드 스크립트 3종 | `scripts/*.sh` |

### C. 프롬프트 패턴/가이드 (6개) - CLAUDE.md 추가

| # | 개선안 | 내용 |
|---|--------|------|
| 7 | 조사 결과 구조화 포맷 | 원시 데이터/관찰/가설 3단계 |
| 8 | 서버 재시작 워크플로우 | 스킬과 연동된 상세 절차 |
| 9 | MCP 체이닝 워크플로우 | 엔드투엔드 조사 계획 |
| 10 | 게시 전 주장 검증 체크리스트 | 사실 대조, 미검증 표시, 어조 점검 |
| 11 | 엔드투엔드 조사 워크플로우 가이드 | 멀티 도구 파이프라인 계획 |
| 12 | 병렬 에이전트 활용 가이드 | Task 도구 기반 분업 패턴 |

6개는 바로 구현 가능, 1개(SSO)는 환경 확인 후 구현, 2개(미래 전망의 자율 파이프라인, 자가 치유 재시작)는 현재 모델의 자체 검증 능력으로는 완전 자율이 어려워 가이드 형태로 반영했다.

---

## 구현

### 1. CLAUDE.md: 서버 관리 규칙

가장 빈번한 작업(176건)의 부분 달성 문제를 해결하기 위해, 5단계 표준 재시작 절차를 CLAUDE.md에 추가했다.

```markdown
## 서버 관리 규칙

서버를 재시작하거나 관리할 때 반드시 아래 절차를 따른다.

**표준 재시작 절차 (5단계):**
1. **인스턴스 탐색**: ps aux | grep, lsof -i :<포트>
2. **전체 종료**: 발견된 모든 인스턴스 종료
3. **포트 확인**: 포트에 프로세스가 남아있지 않은지 확인
4. **새 인스턴스 시작**: 표준 명령어로 서버 시작
5. **검증**: 서버 응답 확인

**주의사항:**
- 새 인스턴스를 시작하기 전에 반드시 기존 인스턴스를 모두 종료한다
- 5단계 검증까지 완료하지 않으면 작업 완료로 간주하지 않는다
```

핵심은 **"5단계 검증까지 완료하지 않으면 작업 완료로 간주하지 않는다"** 규칙이다. 이전에는 Claude가 서버를 시작하기만 하면 완료로 판단했는데, 검증 단계를 강제함으로써 복수 인스턴스 문제를 사전에 잡을 수 있다.

### 2. CLAUDE.md: 분석 및 작성 기준

208건의 사실 오류를 줄이기 위해 세 가지 규칙을 추가했다.

```markdown
## 분석 및 작성 기준

### 작성 규칙
1. **가정을 사실로 기술 금지** — '가능성 높음', '~로 보임' 등 유보적 표현 사용
2. **날짜/요일/수치 재확인** — 제시 전 원본 데이터와 대조
3. **어조 조절** — 간결하고 절제된 어조, 단정적 표현 금지
```

실제 Datadog APM 비용 조사에서 Claude가 "화요일에 필터가 활성화되었다"고 썼는데, 실제로는 수요일이었고 활성화된 증거도 없었다. 이런 종류의 실수를 프롬프트 레벨에서 방지하는 것이다.

### 3. CLAUDE.md: SSO 사전 점검

```markdown
## AWS SSO 로그인 규칙
- AWS CLI 명령어를 실행하기 전에, 먼저 `aws sts get-caller-identity`를 실행하여
  세션 토큰이 유효한지 사전 확인한다.
- 토큰이 만료된 경우, 실제 작업 진행 전에 `aws sso login`을 실행하여 재인증한다.
```

기존에는 "토큰 만료 에러가 발생하면 재인증"이었는데, "작업 전에 미리 확인"으로 변경했다. 비용 분석 중간에 토큰이 끊기는 상황을 사전에 방지한다.

### 4. 커스텀 스킬: /restart

`.claude/skills/restart/SKILL.md`를 생성하여 `/restart` 명령어를 만들었다.

```markdown
# 서버 재시작 스킬

## 절차

### 1단계: 실행 중인 인스턴스 탐색
- ps aux, lsof로 모든 PID와 포트 나열
- 사용자에게 발견 결과를 보여주고, 종료 전 확인

### 2단계: 전체 인스턴스 종료
- kill 명령으로 종료, 5초 대기 후 남아있으면 kill -9

### 3단계: 포트 확인
- 대상 포트에 프로세스가 없는지 확인

### 4단계: 새 인스턴스 시작
- 올바른 프로젝트 디렉토리에서 시작 (가정하지 않고 탐색)

### 5단계: 검증
- curl, 헬스체크 엔드포인트로 정상 확인
- DB 상태가 UI와 동기화되었는지 확인
- Playwright 스크린샷으로 시각적 확인
- 최종 상태 보고
```

CLAUDE.md의 5단계 규칙을 스킬로 구체화한 것이다. `/restart`만 입력하면 매번 동일한 절차를 수행한다. 5단계에 Playwright 스크린샷 검증을 추가하여, DB 데이터가 UI에 정상 반영되었는지까지 확인한다.

### 5. 훅: PostToolUse 자동 린트/포맷

`.claude/settings.json`에 훅을 설정했다.

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "command": "if echo \"$CC_TOOL_INPUT\" | grep -qE '\\.(css|html|js)$';
          then npx prettier --write \"$CC_TOOL_INPUT\" 2>/dev/null; fi;
          if echo \"$CC_TOOL_INPUT\" | grep -qE '\\.py$';
          then ruff check --fix \"$CC_TOOL_INPUT\" 2>/dev/null; fi"
      }
    ]
  }
}
```

Edit 또는 Write 도구가 실행될 때마다:
- `.css`, `.html`, `.js` 파일 → Prettier 자동 포맷팅
- `.py` 파일 → ruff 자동 린트

14,000건의 CSS 작업과 10,000건의 Python 작업에서 포맷팅 왕복을 줄여준다. Claude가 코드를 수정할 때마다 자동으로 정리되므로, 별도의 포맷팅 요청이 필요 없다.

### 6. 헤드리스 모드 스크립트 3종

`claude -p` 명령어로 인터랙티브 세션 없이 Claude를 실행하는 스크립트를 만들었다.

**서버 상태 점검:**

```bash
#!/bin/bash
# scripts/headless-server-health.sh
claude -p "현재 실행 중인 모든 서버 프로세스를 확인하고,
  각 서버의 헬스 엔드포인트에 curl로 접근하여 응답 상태를 확인하라.
  정상/비정상 여부를 요약 테이블로 보고하라." \
  --allowedTools "Bash,Read"
```

**Datadog 비용 점검:**

```bash
#!/bin/bash
# scripts/headless-datadog-cost-check.sh
DAYS=${1:-7}
claude -p "Datadog MCP를 사용하여 최근 ${DAYS}일간 APM 사용량을 조회하고,
  20% 이상의 비용 급증을 요약하여 마크다운 테이블로 포맷하라.
  결과를 원시 데이터 / 관찰 / 가설 구조로 제시하라." \
  --allowedTools "mcp__datadog__logs,mcp__datadog__traces,mcp__datadog__metrics,Read,Bash"
```

**서버 재시작:**

```bash
#!/bin/bash
# scripts/headless-server-restart.sh
PORT=${1:-8080}
claude -p "포트 ${PORT}의 모든 실행 중인 서버 인스턴스를 찾아 종료하고,
  포트가 비었는지 확인한 후, 표준 명령어로 서버를 시작하라.
  최종 상태를 보고하라." \
  --allowedTools "Bash,Read"
```

cron이나 CI/CD에서 자동 실행할 수 있다. `--allowedTools`로 도구를 제한하여 의도하지 않은 동작을 방지한다.

### 7~12. 프롬프트 패턴 및 가이드

나머지 6개는 CLAUDE.md의 `## 분석 및 작성 기준` 섹션에 서브섹션으로 추가했다.

**조사 결과 구조화 포맷:**

```
[원시 데이터]
• 찾은 정확한 수치와 타임스탬프

[관찰]
• 발견한 패턴과 신뢰도 (높음/중간/낮음)

[가설]
• 미검증으로 명시된 가능한 설명
```

**게시 전 주장 검증 체크리스트:**

1. 사실 주장 재대조 — 날짜, 수치, 인과 관계를 원시 데이터와 대조
2. 미검증 주장 표시 — '확인 필요' 또는 '추정'으로 명시
3. 어조 최종 점검 — 단정적 표현이 남아있지 않은지 확인
4. 사용자 리뷰 — 게시 전 초안을 보여주고 승인

**엔드투엔드 조사 워크플로우:**

```
1. Datadog 로그/트레이스 조회
2. 데이터 분석
3. 결과 구조화 (원시 데이터 → 관찰 → 가설)
4. 게시 전 주장 검증
5. Slack/Jira 게시 (사용자 승인 후)
```

**병렬 에이전트 활용 가이드:**

```
에이전트 1 (콘텐츠): Markdown/HTML 카피 수정
에이전트 2 (스타일링): CSS/HTML 조정
에이전트 3 (검증): Playwright 스크린샷 시각적 검증
```

---

## 구현 결과 정리

```mermaid
flowchart LR
    subgraph 문제["반복 마찰"]
        A[서버 재시작 실패<br/>176건]
        B[사실 오류<br/>208건]
        C[SSO 만료<br/>7건]
    end

    subgraph 해결["구현한 것"]
        D[CLAUDE.md<br/>서버 관리 5단계]
        E[/restart 스킬]
        F[CLAUDE.md<br/>분석/작성 기준]
        G[게시 전 검증<br/>체크리스트]
        H[SSO 사전 점검]
        I[PostToolUse 훅<br/>Prettier + ruff]
        J[헤드리스 스크립트<br/>3종]
        K[병렬 에이전트<br/>가이드]
    end

    A --> D
    A --> E
    B --> F
    B --> G
    C --> H

    style 문제 fill:#fef2f2,stroke:#fca5a5
    style 해결 fill:#f0fdf4,stroke:#86efac
```

| 카테고리 | 파일 | 개수 |
|---------|------|------|
| CLAUDE.md 추가 | `CLAUDE.md` | 7개 섹션 |
| 커스텀 스킬 | `.claude/skills/restart/SKILL.md` | 1개 |
| 훅 | `.claude/settings.json` | 1개 |
| 헤드리스 스크립트 | `scripts/*.sh` | 3개 |

---

## 아직 하지 않은 것

- **효과 정량 측정**: 개선안 반영 후 마찰 건수가 실제로 줄었는지 확인하려면 다음 `/insights` 리포트를 봐야 한다. 개선 전후를 비교할 수 있는 기준선이 이번 리포트다.
- **완전 자율 파이프라인**: 미래 전망에서 제안한 "Datadog 조사 → 자체 팩트체크 → Jira/Slack 게시"까지의 완전 자동화는, 현재 모델의 자체 검증 능력으로는 사람의 최종 승인 없이 게시하기 어렵다. 가이드라인과 검증 체크리스트를 넣어서 사람의 개입을 최소화하는 방향으로 접근했다.
- **헤드리스 스크립트 cron 등록**: 스크립트는 만들었지만 아직 cron이나 스케줄러에 연결하지 않았다. 수동 실행으로 충분히 검증한 후 자동화할 계획이다.
- **/draft 스킬**: 리포트에서 콘텐츠 작성(160건)에 어조/정확성 가이드라인을 내장한 스킬을 제안했는데, CLAUDE.md의 분석/작성 기준으로 어느 정도 커버되므로 별도 스킬은 보류했다.

---

## 느낀 점

/insights 리포트를 보기 전에는 "Claude가 가끔 틀린다"는 막연한 불만이었다. 리포트를 보고 나서는 "서버 재시작 176건이 부분 달성, 잘못된 접근 208건, SSO 만료 7건"이라는 구체적 숫자가 되었다. 숫자가 보이니 어디를 고쳐야 하는지도 보였다.

도구를 잘 쓰려면 도구가 뭘 하고 있는지 관측할 수 있어야 한다. 시스템의 Observability가 중요하듯, 도구 사용 패턴의 Observability도 중요하다. /insights는 Claude Code 사용 방법에 대한 모니터링 대시보드 같은 역할을 한다.

12개 개선안을 반영하는 데 한 세션이면 충분했다. CLAUDE.md 수정, 스킬 생성, 훅 설정, 스크립트 작성까지 전부 Claude Code로 했다. 도구가 자기 자신의 사용 방법을 분석하고, 그 결과를 자기 자신에게 반영하는 셀프 피드백 루프다.
